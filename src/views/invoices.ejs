<div class="page-header">
  <h2><i class="fas fa-file-invoice-dollar"></i> Invoices</h2>
  <p>Manage billing and generate invoices</p>
</div>

<!-- Filter and Add -->
<div class="flex-between mb-3">
  <div class="flex gap-1">
    <select id="statusFilter" class="form-control" style="width: auto;" onchange="loadInvoices()">
      <option value="">All Status</option>
      <option value="Paid">Paid</option>
      <option value="Unpaid">Unpaid</option>
    </select>
  </div>
  <button class="btn btn-primary" onclick="showAddModal()">
    <i class="fas fa-plus"></i> New Invoice
  </button>
</div>

<!-- Invoices Table -->
<div class="card">
  <div class="table-container">
    <table>
      <thead>
        <tr>
          <th>Invoice #</th>
          <th>Date</th>
          <th>Client</th>
          <th>Amount</th>
          <th>Status</th>
          <th>Actions</th>
        </tr>
      </thead>
      <tbody id="invoicesTable">
        <tr>
          <td colspan="6" class="text-center">
            <div class="spinner"></div>
          </td>
        </tr>
      </tbody>
    </table>
  </div>
</div>

<!-- Add Invoice Modal -->
<div id="invoiceModal" class="modal hidden" style="position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 2000; display: none; align-items: center; justify-content: center;">
  <div class="card" style="width: 90%; max-width: 800px; max-height: 90vh; overflow-y: auto;">
    <div class="card-header">
      <h3 class="card-title">New Invoice</h3>
      <button onclick="closeModal()" style="background: none; border: none; font-size: 1.5rem; cursor: pointer;">&times;</button>
    </div>
    <form id="invoiceForm" onsubmit="saveInvoice(event)">
      <div class="form-group">
        <label class="form-label">Client *</label>
        <input
          type="text"
          id="clientSearch"
          class="form-control"
          placeholder="Search client by name, email, or phone..."
          autocomplete="off"
          onkeyup="filterClients()"
          onfocus="showClientDropdown()"
        >
        <select id="invoiceClient" class="form-control" required style="margin-top: 5px;" size="5" onchange="selectClient()" onfocus="showClientDropdown()">
          <option value="">-- Select a client --</option>
        </select>
        <input type="hidden" id="selectedClientId" required>
      </div>

      <div class="form-group">
        <label class="form-label">Invoice Date</label>
        <input type="date" id="invoiceDate" class="form-control" required>
      </div>

      <div class="form-group">
        <label class="form-label">Status</label>
        <select id="invoiceStatus" class="form-control" required>
          <option value="Unpaid">Unpaid</option>
          <option value="Paid">Paid</option>
        </select>
      </div>

      <div class="form-group">
        <label class="form-label">Items/Services *</label>
        <div id="itemsContainer" style="border: 1px solid #ddd; padding: 10px; border-radius: 4px; margin-bottom: 10px; max-height: 300px; overflow-y: auto;">
          <!-- Items will be added here -->
        </div>
        <button type="button" class="btn btn-secondary" onclick="showAddItemModal()">
          <i class="fas fa-plus"></i> Add Item/Service
        </button>
      </div>

      <div class="form-group" style="background: #f5f5f5; padding: 15px; border-radius: 4px;">
        <div style="display: flex; justify-content: space-between; align-items: center;">
          <label class="form-label" style="margin: 0; font-size: 1.2rem; font-weight: bold;">Total Amount:</label>
          <span id="totalAmount" style="font-size: 1.5rem; font-weight: bold; color: #2d6a4f;">₱0.00</span>
        </div>
      </div>

      <div class="form-group">
        <label class="form-label">Notes</label>
        <textarea id="invoiceNotes" class="form-control" rows="2" placeholder="Additional notes..."></textarea>
      </div>

      <div class="flex gap-1">
        <button type="submit" class="btn btn-primary">
          <i class="fas fa-save"></i> Create Invoice
        </button>
        <button type="button" class="btn btn-secondary" onclick="closeModal()">
          <i class="fas fa-times"></i> Cancel
        </button>
      </div>
    </form>
  </div>
</div>

<!-- Add Item to Invoice Modal -->
<div id="addItemModal" class="modal hidden" style="position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 2001; display: none; align-items: center; justify-content: center;">
  <div class="card" style="width: 90%; max-width: 500px;">
    <div class="card-header">
      <h3 class="card-title">Add Item/Service</h3>
      <button onclick="closeAddItemModal()" style="background: none; border: none; font-size: 1.5rem; cursor: pointer;">&times;</button>
    </div>
    <div style="padding: 20px;">
      <div class="form-group">
        <label class="form-label">Select Item/Service *</label>
        <select id="selectedItem" class="form-control" required onchange="updateItemPrice()">
          <option value="">-- Select an item --</option>
        </select>
      </div>

      <div class="form-row">
        <div class="form-group">
          <label class="form-label">Quantity *</label>
          <input type="number" id="itemQuantity" class="form-control" min="1" value="1" required onchange="updateItemSubtotal()">
        </div>

        <div class="form-group">
          <label class="form-label">Price Each *</label>
          <input type="number" id="itemPrice" class="form-control" step="0.01" min="0" required onchange="updateItemSubtotal()">
        </div>
      </div>

      <div class="form-group">
        <label class="form-label">Subtotal</label>
        <input type="text" id="itemSubtotal" class="form-control" readonly value="₱0.00">
      </div>

      <div class="flex gap-1">
        <button type="button" class="btn btn-primary" onclick="addItemToInvoice()">
          <i class="fas fa-plus"></i> Add to Invoice
        </button>
        <button type="button" class="btn btn-secondary" onclick="closeAddItemModal()">
          <i class="fas fa-times"></i> Cancel
        </button>
      </div>
    </div>
  </div>
</div>

<script>
  async function loadInvoices() {
    const status = document.getElementById('statusFilter').value;
    const tbody = document.getElementById('invoicesTable');

    let url = '/api/invoices';
    if (status) {
      url += `?status=${status}`;
    }

    try {
      const response = await fetch(url);
      const result = await response.json();

      if (result.success) {
        if (result.data.length === 0) {
          tbody.innerHTML = '<tr><td colspan="6" class="text-center">No invoices found</td></tr>';
        } else {
          tbody.innerHTML = result.data.map(invoice => {
            const date = new Date(invoice.date).toLocaleDateString();
            const statusBadge = invoice.status === 'Paid' ? 'badge-success' : 'badge-warning';

            return `
              <tr>
                <td>${invoice.invoiceNumber}</td>
                <td>${date}</td>
                <td>${invoice.client.name}</td>
                <td>₱${invoice.totalAmount.toFixed(2)}</td>
                <td><span class="badge ${statusBadge}">${invoice.status}</span></td>
                <td>
                  <button class="btn btn-sm btn-secondary" onclick="viewInvoice(${invoice.id})">
                    <i class="fas fa-eye"></i> View
                  </button>
                  <a href="/api/invoices/${invoice.id}/pdf" class="btn btn-sm btn-primary" target="_blank">
                    <i class="fas fa-file-pdf"></i> PDF
                  </a>
                  <button class="btn btn-sm btn-danger" onclick="deleteInvoice(${invoice.id})">
                    <i class="fas fa-trash"></i> Delete
                  </button>
                </td>
              </tr>
            `;
          }).join('');
        }
      }
    } catch (error) {
      console.error('Error loading invoices:', error);
      tbody.innerHTML = '<tr><td colspan="6" class="text-center">Error loading invoices</td></tr>';
    }
  }

  let allClients = [];
  let allItems = [];
  let invoiceItems = [];

  async function loadClients() {
    try {
      const response = await fetch('/api/clients');
      const result = await response.json();
      if (result.success) {
        allClients = result.data;
        displayClients(allClients);
      }
    } catch (error) {
      console.error('Error loading clients:', error);
    }
  }

  async function loadItems() {
    try {
      const response = await fetch('/api/items');
      const result = await response.json();
      if (result.success) {
        allItems = result.data;
        displayItems(allItems);
      }
    } catch (error) {
      console.error('Error loading items:', error);
    }
  }

  function displayClients(clients) {
    const select = document.getElementById('invoiceClient');
    select.innerHTML = '<option value="">-- Select a client --</option>';
    clients.forEach(client => {
      const option = document.createElement('option');
      option.value = client.id;
      option.textContent = `${client.name}${client.email ? ' - ' + client.email : ''}${client.phone ? ' - ' + client.phone : ''}`;
      select.appendChild(option);
    });
  }

  function displayItems(items) {
    const select = document.getElementById('selectedItem');
    select.innerHTML = '<option value="">-- Select an item --</option>';
    items.forEach(item => {
      const option = document.createElement('option');
      option.value = item.id;
      option.setAttribute('data-price', item.price);
      option.setAttribute('data-name', item.name);
      option.textContent = `${item.name} - ₱${item.price.toFixed(2)}`;
      select.appendChild(option);
    });
  }

  function filterClients() {
    const searchTerm = document.getElementById('clientSearch').value.toLowerCase();
    if (searchTerm === '') {
      displayClients(allClients);
      return;
    }
    const filtered = allClients.filter(client =>
      client.name.toLowerCase().includes(searchTerm) ||
      (client.email && client.email.toLowerCase().includes(searchTerm)) ||
      (client.phone && client.phone.includes(searchTerm))
    );
    displayClients(filtered);
    const select = document.getElementById('invoiceClient');
    select.style.display = 'block';
  }

  function selectClient() {
    const select = document.getElementById('invoiceClient');
    const selectedOption = select.options[select.selectedIndex];
    if (selectedOption.value) {
      document.getElementById('clientSearch').value = selectedOption.textContent;
      document.getElementById('selectedClientId').value = selectedOption.value;
      select.style.display = 'none';
    }
  }

  function showClientDropdown() {
    const select = document.getElementById('invoiceClient');
    select.style.display = 'block';
  }

  // Hide dropdown when clicking outside
  document.addEventListener('click', function(e) {
    const select = document.getElementById('invoiceClient');
    const searchInput = document.getElementById('clientSearch');
    if (select && searchInput && e.target !== select && e.target !== searchInput) {
      select.style.display = 'none';
    }
  });

  async function showAddModal() {
    await loadClients();
    await loadItems();

    document.getElementById('invoiceForm').reset();
    document.getElementById('selectedClientId').value = '';
    document.getElementById('clientSearch').value = '';
    document.getElementById('invoiceClient').style.display = 'none';

    // Set default date to today
    const today = new Date().toISOString().split('T')[0];
    document.getElementById('invoiceDate').value = today;

    // Reset invoice items
    invoiceItems = [];
    updateItemsDisplay();

    document.getElementById('invoiceModal').classList.remove('hidden');
    document.getElementById('invoiceModal').style.display = 'flex';
  }

  function closeModal() {
    document.getElementById('invoiceModal').classList.add('hidden');
    document.getElementById('invoiceModal').style.display = 'none';
  }

  function showAddItemModal() {
    document.getElementById('selectedItem').value = '';
    document.getElementById('itemQuantity').value = '1';
    document.getElementById('itemPrice').value = '';
    document.getElementById('itemSubtotal').value = '$0.00';

    document.getElementById('addItemModal').classList.remove('hidden');
    document.getElementById('addItemModal').style.display = 'flex';
  }

  function closeAddItemModal() {
    document.getElementById('addItemModal').classList.add('hidden');
    document.getElementById('addItemModal').style.display = 'none';
  }

  function updateItemPrice() {
    const select = document.getElementById('selectedItem');
    const selectedOption = select.options[select.selectedIndex];
    if (selectedOption.value) {
      const price = parseFloat(selectedOption.getAttribute('data-price'));
      document.getElementById('itemPrice').value = price.toFixed(2);
      updateItemSubtotal();
    }
  }

  function updateItemSubtotal() {
    const quantity = parseFloat(document.getElementById('itemQuantity').value) || 0;
    const price = parseFloat(document.getElementById('itemPrice').value) || 0;
    const subtotal = quantity * price;
    document.getElementById('itemSubtotal').value = '₱' + subtotal.toFixed(2);
  }

  function addItemToInvoice() {
    const select = document.getElementById('selectedItem');
    const selectedOption = select.options[select.selectedIndex];

    if (!selectedOption.value) {
      alert('Please select an item');
      return;
    }

    const quantity = parseInt(document.getElementById('itemQuantity').value);
    const price = parseFloat(document.getElementById('itemPrice').value);

    if (quantity <= 0 || price < 0) {
      alert('Invalid quantity or price');
      return;
    }

    const item = {
      itemId: parseInt(selectedOption.value),
      name: selectedOption.getAttribute('data-name'),
      quantity: quantity,
      priceEach: price,
      subtotal: quantity * price
    };

    invoiceItems.push(item);
    updateItemsDisplay();
    closeAddItemModal();
  }

  function removeInvoiceItem(index) {
    invoiceItems.splice(index, 1);
    updateItemsDisplay();
  }

  function updateItemsDisplay() {
    const container = document.getElementById('itemsContainer');

    if (invoiceItems.length === 0) {
      container.innerHTML = '<p style="color: #666; text-align: center; margin: 10px 0;">No items added yet. Click "Add Item/Service" to add items.</p>';
      document.getElementById('totalAmount').textContent = '₱0.00';
      return;
    }

    let total = 0;
    container.innerHTML = invoiceItems.map((item, index) => {
      total += item.subtotal;
      return `
        <div style="display: flex; justify-content: space-between; align-items: center; padding: 8px; border-bottom: 1px solid #eee;">
          <div style="flex: 1;">
            <strong>${item.name}</strong><br>
            <small>${item.quantity} × ₱${item.priceEach.toFixed(2)}</small>
          </div>
          <div style="font-weight: bold; margin-right: 10px;">₱${item.subtotal.toFixed(2)}</div>
          <button type="button" class="btn btn-sm btn-danger" onclick="removeInvoiceItem(${index})" style="padding: 4px 8px;">
            <i class="fas fa-times"></i>
          </button>
        </div>
      `;
    }).join('');

    document.getElementById('totalAmount').textContent = '₱' + total.toFixed(2);
  }

  async function saveInvoice(event) {
    event.preventDefault();

    const clientId = document.getElementById('selectedClientId').value;
    if (!clientId) {
      alert('Please select a client');
      return;
    }

    if (invoiceItems.length === 0) {
      alert('Please add at least one item to the invoice');
      return;
    }

    const totalAmount = invoiceItems.reduce((sum, item) => sum + item.subtotal, 0);

    const data = {
      clientId: parseInt(clientId),
      date: document.getElementById('invoiceDate').value,
      status: document.getElementById('invoiceStatus').value,
      notes: document.getElementById('invoiceNotes').value || null,
      totalAmount: totalAmount,
      items: invoiceItems.map(item => ({
        itemId: item.itemId,
        quantity: item.quantity,
        priceEach: item.priceEach,
        subtotal: item.subtotal
      }))
    };

    try {
      const response = await fetch('/api/invoices', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(data),
      });

      const result = await response.json();

      if (result.success) {
        alert('Invoice created successfully!');
        closeModal();
        loadInvoices();
      } else {
        alert('Error: ' + result.message);
      }
    } catch (error) {
      console.error('Error saving invoice:', error);
      alert('Error creating invoice');
    }
  }

  function viewInvoice(id) {
    alert(`View invoice ${id} details`);
  }

  async function deleteInvoice(id) {
    if (!confirm('Are you sure you want to delete this invoice?')) return;

    try {
      const response = await fetch(`/api/invoices/${id}`, { method: 'DELETE' });
      const result = await response.json();

      if (result.success) {
        alert(result.message);
        loadInvoices();
      } else {
        alert('Error: ' + result.message);
      }
    } catch (error) {
      console.error('Error deleting invoice:', error);
      alert('Error deleting invoice');
    }
  }

  loadInvoices();
</script>
