<div class="page-header">
  <h2><i class="fas fa-file-invoice-dollar"></i> Invoices</h2>
  <p>Manage billing and generate invoices</p>
</div>

<!-- Filter and Add -->
<div class="flex-between mb-3">
  <div class="flex gap-1">
    <select id="statusFilter" class="form-control" style="width: auto;" onchange="loadInvoices()">
      <option value="">All Status</option>
      <option value="Paid">Paid</option>
      <option value="Unpaid">Unpaid</option>
    </select>
  </div>
  <button class="btn btn-primary" onclick="showAddModal()">
    <i class="fas fa-plus"></i> New Invoice
  </button>
</div>

<!-- Invoices Table -->
<div class="card">
  <div class="table-container">
    <table>
      <thead>
        <tr>
          <th>Invoice #</th>
          <th>Date</th>
          <th>Client</th>
          <th>Amount</th>
          <th>Status</th>
          <th>Actions</th>
        </tr>
      </thead>
      <tbody id="invoicesTable">
        <tr>
          <td colspan="6" class="text-center">
            <div class="spinner"></div>
          </td>
        </tr>
      </tbody>
    </table>
  </div>
</div>

<script>
  async function loadInvoices() {
    const status = document.getElementById('statusFilter').value;
    const tbody = document.getElementById('invoicesTable');

    let url = '/api/invoices';
    if (status) {
      url += `?status=${status}`;
    }

    try {
      const response = await fetch(url);
      const result = await response.json();

      if (result.success) {
        if (result.data.length === 0) {
          tbody.innerHTML = '<tr><td colspan="6" class="text-center">No invoices found</td></tr>';
        } else {
          tbody.innerHTML = result.data.map(invoice => {
            const date = new Date(invoice.date).toLocaleDateString();
            const statusBadge = invoice.status === 'Paid' ? 'badge-success' : 'badge-warning';

            return `
              <tr>
                <td>${invoice.invoiceNumber}</td>
                <td>${date}</td>
                <td>${invoice.client.name}</td>
                <td>$${invoice.totalAmount.toFixed(2)}</td>
                <td><span class="badge ${statusBadge}">${invoice.status}</span></td>
                <td>
                  <button class="btn btn-sm btn-secondary" onclick="viewInvoice(${invoice.id})">
                    <i class="fas fa-eye"></i> View
                  </button>
                  <a href="/api/invoices/${invoice.id}/pdf" class="btn btn-sm btn-primary" target="_blank">
                    <i class="fas fa-file-pdf"></i> PDF
                  </a>
                  <button class="btn btn-sm btn-danger" onclick="deleteInvoice(${invoice.id})">
                    <i class="fas fa-trash"></i> Delete
                  </button>
                </td>
              </tr>
            `;
          }).join('');
        }
      }
    } catch (error) {
      console.error('Error loading invoices:', error);
      tbody.innerHTML = '<tr><td colspan="6" class="text-center">Error loading invoices</td></tr>';
    }
  }

  function showAddModal() {
    alert('Create Invoice - Select client and add items');
  }

  function viewInvoice(id) {
    alert(`View invoice ${id} details`);
  }

  async function deleteInvoice(id) {
    if (!confirm('Are you sure you want to delete this invoice?')) return;

    try {
      const response = await fetch(`/api/invoices/${id}`, { method: 'DELETE' });
      const result = await response.json();

      if (result.success) {
        alert(result.message);
        loadInvoices();
      } else {
        alert('Error: ' + result.message);
      }
    } catch (error) {
      console.error('Error deleting invoice:', error);
      alert('Error deleting invoice');
    }
  }

  loadInvoices();
</script>
