<div class="page-header">
  <h2><i class="fas fa-truck-loading"></i> Receiving Reports</h2>
  <p>Track inventory receipts from purchase orders</p>
</div>

<div class="card">
  <div class="card-header">
    <div class="filter-bar" style="margin: 0; flex: 1;">
      <input type="text" id="searchInput" placeholder="Search RR#..." class="form-control" style="max-width: 200px;" onkeyup="filterReports()">
      <select id="supplierFilter" class="form-control" style="max-width: 200px;" onchange="filterReports()">
        <option value="">All Suppliers</option>
      </select>
      <div class="filter-group">
        <label>From:</label>
        <input type="date" id="startDate" class="form-control" onchange="loadReports()">
      </div>
      <div class="filter-group">
        <label>To:</label>
        <input type="date" id="endDate" class="form-control" onchange="loadReports()">
      </div>
    </div>
    <button class="btn btn-primary" onclick="openRRModal()">
      <i class="fas fa-plus"></i> New Receiving Report
    </button>
  </div>

  <div class="table-container">
    <table>
      <thead>
        <tr>
          <th>RR Number</th>
          <th>Date Received</th>
          <th>PO Number</th>
          <th>Supplier</th>
          <th>Items Received</th>
          <th>Actions</th>
        </tr>
      </thead>
      <tbody id="reportsTable">
        <tr><td colspan="6" class="text-center"><div class="spinner"></div></td></tr>
      </tbody>
    </table>
  </div>
</div>

<!-- Receiving Report Modal -->
<div class="modal-overlay" id="rrModal">
  <div class="modal" style="max-width: 900px;">
    <div class="modal-header">
      <h3 id="rrModalTitle">New Receiving Report</h3>
      <button class="modal-close" onclick="closeRRModal()">&times;</button>
    </div>
    <form id="rrForm">
      <input type="hidden" id="rrId">

      <div class="form-row">
        <div class="form-group">
          <label class="form-label">Purchase Order *</label>
          <select id="purchaseOrderId" class="form-control" required onchange="loadPOItems()">
            <option value="">Select Purchase Order</option>
          </select>
        </div>
        <div class="form-group">
          <label class="form-label">Date Received *</label>
          <input type="date" id="dateReceived" class="form-control" required>
        </div>
      </div>

      <div id="poDetails" style="display: none;">
        <div class="alert alert-info">
          <strong>Supplier:</strong> <span id="poSupplier">-</span> |
          <strong>PO Date:</strong> <span id="poDate">-</span> |
          <strong>PO Total:</strong> <span id="poTotalDisplay">₱0.00</span>
        </div>

        <h4>Items to Receive</h4>
        <table class="table" id="rrItemsTable">
          <thead>
            <tr>
              <th>Item</th>
              <th>Ordered</th>
              <th>Previously Received</th>
              <th>Receive Now</th>
            </tr>
          </thead>
          <tbody id="rrItemsBody">
          </tbody>
        </table>
      </div>

      <div class="form-group">
        <label class="form-label">Notes</label>
        <textarea id="notes" class="form-control textarea" rows="2" placeholder="Delivery notes, condition of items..."></textarea>
      </div>

      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" onclick="closeRRModal()">Cancel</button>
        <button type="submit" class="btn btn-primary"><i class="fas fa-save"></i> Save Receiving Report</button>
      </div>
    </form>
  </div>
</div>

<!-- View RR Modal -->
<div class="modal-overlay" id="viewRRModal">
  <div class="modal" style="max-width: 800px;">
    <div class="modal-header">
      <h3>Receiving Report Details</h3>
      <button class="modal-close" onclick="closeViewRRModal()">&times;</button>
    </div>
    <div id="viewRRContent">
      <!-- Content loaded dynamically -->
    </div>
    <div class="modal-footer">
      <button type="button" class="btn btn-secondary" onclick="closeViewRRModal()">Close</button>
      <button type="button" class="btn btn-primary" onclick="printRR()"><i class="fas fa-print"></i> Print</button>
    </div>
  </div>
</div>

<script>
  let reports = [];
  let suppliers = [];
  let purchaseOrders = [];
  let currentRR = null;
  let currentPOItems = [];

  document.addEventListener('DOMContentLoaded', function() {
    const today = new Date();
    const firstDay = new Date(today.getFullYear(), today.getMonth(), 1);
    document.getElementById('startDate').value = firstDay.toISOString().split('T')[0];
    document.getElementById('endDate').value = today.toISOString().split('T')[0];
    document.getElementById('dateReceived').value = today.toISOString().split('T')[0];

    // Check for PO ID in URL
    const urlParams = new URLSearchParams(window.location.search);
    const poId = urlParams.get('poId');

    loadSuppliers();
    loadPurchaseOrders(poId);
    loadReports();
    document.getElementById('rrForm').addEventListener('submit', handleSubmit);
  });

  async function loadSuppliers() {
    try {
      const response = await fetch('/api/suppliers');
      const result = await response.json();
      if (result.success) {
        suppliers = result.data;
        const filterSelect = document.getElementById('supplierFilter');
        filterSelect.innerHTML = '<option value="">All Suppliers</option>';
        suppliers.forEach(s => {
          filterSelect.innerHTML += `<option value="${s.id}">${s.name}</option>`;
        });
      }
    } catch (error) {
      console.error('Error:', error);
    }
  }

  async function loadPurchaseOrders(preselectedId = null) {
    try {
      const response = await fetch('/api/purchase-orders?status=Approved,Partially Received');
      const result = await response.json();
      if (result.success) {
        purchaseOrders = result.data;
        const poSelect = document.getElementById('purchaseOrderId');
        poSelect.innerHTML = '<option value="">Select Purchase Order</option>';
        purchaseOrders.forEach(po => {
          poSelect.innerHTML += `<option value="${po.id}">${po.poNumber} - ${po.supplier?.name || 'Unknown'} (${new Date(po.orderDate).toLocaleDateString()})</option>`;
        });

        if (preselectedId) {
          poSelect.value = preselectedId;
          loadPOItems();
          openRRModal();
        }
      }
    } catch (error) {
      console.error('Error:', error);
    }
  }

  async function loadPOItems() {
    const poId = document.getElementById('purchaseOrderId').value;
    const detailsDiv = document.getElementById('poDetails');

    if (!poId) {
      detailsDiv.style.display = 'none';
      return;
    }

    try {
      const response = await fetch(`/api/purchase-orders/${poId}`);
      const result = await response.json();
      if (result.success) {
        const po = result.data;
        document.getElementById('poSupplier').textContent = po.supplier?.name || '-';
        document.getElementById('poDate').textContent = new Date(po.orderDate).toLocaleDateString();
        document.getElementById('poTotalDisplay').textContent = '₱' + (po.totalAmount?.toFixed(2) || '0.00');

        currentPOItems = po.items || [];
        renderRRItems();
        detailsDiv.style.display = 'block';
      }
    } catch (error) {
      console.error('Error:', error);
    }
  }

  function renderRRItems() {
    const tbody = document.getElementById('rrItemsBody');
    tbody.innerHTML = currentPOItems.map(item => {
      const remaining = (item.quantity || 0) - (item.receivedQuantity || 0);
      return `
        <tr>
          <td>${item.item?.name || '-'}</td>
          <td>${item.quantity}</td>
          <td>${item.receivedQuantity || 0}</td>
          <td>
            <input type="number" class="form-control rr-qty"
                   data-item-id="${item.itemId}"
                   data-po-item-id="${item.id}"
                   min="0" max="${remaining}"
                   value="${remaining}"
                   style="width: 100px;">
          </td>
        </tr>
      `;
    }).join('');
  }

  async function loadReports() {
    const startDate = document.getElementById('startDate').value;
    const endDate = document.getElementById('endDate').value;

    try {
      const response = await fetch(`/api/receiving-reports?startDate=${startDate}&endDate=${endDate}`);
      const result = await response.json();
      if (result.success) {
        reports = result.data;
        renderReports();
      }
    } catch (error) {
      console.error('Error:', error);
    }
  }

  function renderReports() {
    const tbody = document.getElementById('reportsTable');
    const search = document.getElementById('searchInput').value.toLowerCase();
    const supplierFilter = document.getElementById('supplierFilter').value;

    let filtered = reports.filter(r => {
      const matchSearch = !search || r.rrNumber?.toLowerCase().includes(search) || r.purchaseOrder?.poNumber?.toLowerCase().includes(search);
      const matchSupplier = !supplierFilter || r.purchaseOrder?.supplierId == supplierFilter;
      return matchSearch && matchSupplier;
    });

    if (filtered.length === 0) {
      tbody.innerHTML = '<tr><td colspan="6" class="text-center">No receiving reports found</td></tr>';
      return;
    }

    tbody.innerHTML = filtered.map(r => `
      <tr>
        <td><strong>${r.rrNumber}</strong></td>
        <td>${new Date(r.dateReceived).toLocaleDateString()}</td>
        <td>${r.purchaseOrder?.poNumber || '-'}</td>
        <td>${r.purchaseOrder?.supplier?.name || '-'}</td>
        <td>${r.items?.length || 0} items</td>
        <td>
          <div class="action-buttons">
            <button class="btn btn-sm btn-info" onclick="viewRR(${r.id})"><i class="fas fa-eye"></i></button>
          </div>
        </td>
      </tr>
    `).join('');
  }

  function filterReports() {
    renderReports();
  }

  function openRRModal() {
    document.getElementById('rrModalTitle').textContent = 'New Receiving Report';
    document.getElementById('rrForm').reset();
    document.getElementById('rrId').value = '';
    document.getElementById('dateReceived').value = new Date().toISOString().split('T')[0];
    document.getElementById('poDetails').style.display = 'none';
    document.getElementById('rrModal').classList.add('active');
  }

  function closeRRModal() {
    document.getElementById('rrModal').classList.remove('active');
    currentPOItems = [];
  }

  async function viewRR(id) {
    try {
      const response = await fetch(`/api/receiving-reports/${id}`);
      const result = await response.json();
      if (result.success) {
        currentRR = result.data;
        renderRRDetails(currentRR);
        document.getElementById('viewRRModal').classList.add('active');
      }
    } catch (error) {
      console.error('Error:', error);
    }
  }

  function renderRRDetails(rr) {
    const content = document.getElementById('viewRRContent');
    content.innerHTML = `
      <div class="rr-details">
        <div class="form-row">
          <div class="form-group">
            <label class="form-label">RR Number</label>
            <p><strong>${rr.rrNumber}</strong></p>
          </div>
          <div class="form-group">
            <label class="form-label">Date Received</label>
            <p>${new Date(rr.dateReceived).toLocaleDateString()}</p>
          </div>
        </div>
        <div class="form-row">
          <div class="form-group">
            <label class="form-label">Purchase Order</label>
            <p>${rr.purchaseOrder?.poNumber || '-'}</p>
          </div>
          <div class="form-group">
            <label class="form-label">Supplier</label>
            <p>${rr.purchaseOrder?.supplier?.name || '-'}</p>
          </div>
        </div>
        <div class="form-group">
          <label class="form-label">Received By</label>
          <p>${rr.receivedBy?.name || '-'}</p>
        </div>
        <h4>Items Received</h4>
        <table class="table">
          <thead>
            <tr>
              <th>Item</th>
              <th>Quantity Received</th>
            </tr>
          </thead>
          <tbody>
            ${rr.items?.map(i => `
              <tr>
                <td>${i.item?.name || '-'}</td>
                <td>${i.quantityReceived}</td>
              </tr>
            `).join('') || '<tr><td colspan="2">No items</td></tr>'}
          </tbody>
        </table>
        ${rr.notes ? `<p><strong>Notes:</strong> ${rr.notes}</p>` : ''}
      </div>
    `;
  }

  function closeViewRRModal() {
    document.getElementById('viewRRModal').classList.remove('active');
    currentRR = null;
  }

  async function handleSubmit(e) {
    e.preventDefault();

    const rrItems = [];
    document.querySelectorAll('.rr-qty').forEach(input => {
      const qty = parseInt(input.value) || 0;
      if (qty > 0) {
        rrItems.push({
          itemId: parseInt(input.dataset.itemId),
          quantityReceived: qty,
        });
      }
    });

    if (rrItems.length === 0) {
      alert('Please enter quantity for at least one item');
      return;
    }

    const data = {
      purchaseOrderId: parseInt(document.getElementById('purchaseOrderId').value),
      dateReceived: document.getElementById('dateReceived').value,
      notes: document.getElementById('notes').value,
      items: rrItems,
    };

    try {
      const response = await fetch('/api/receiving-reports', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(data),
      });

      const result = await response.json();
      if (result.success) {
        alert('Receiving report created and inventory updated!');
        closeRRModal();
        loadReports();
        loadPurchaseOrders();
      } else {
        alert(result.message || 'Failed to save');
      }
    } catch (error) {
      console.error('Error:', error);
      alert('An error occurred');
    }
  }

  function printRR() {
    if (!currentRR) return;
    window.print();
  }
</script>
