<div class="page-header">
  <h2><i class="fas fa-boxes"></i> Inventory</h2>
  <p>Manage clinic inventory and track stock levels</p>
</div>

<!-- Search and Filter -->
<div class="flex-between mb-3">
  <div class="flex gap-1" style="flex: 1; max-width: 600px;">
    <input type="text" id="searchInput" class="form-control" placeholder="Search items...">
    <button class="btn btn-secondary" onclick="loadItems()">
      <i class="fas fa-search"></i> Search
    </button>
    <button class="btn btn-secondary" onclick="loadLowStock()">
      <i class="fas fa-exclamation-triangle"></i> Low Stock
    </button>
  </div>
  <button class="btn btn-primary" onclick="showAddModal()">
    <i class="fas fa-plus"></i> Add Item
  </button>
</div>

<!-- Inventory Table -->
<div class="card">
  <div class="table-container">
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Quantity</th>
          <th>Min. Quantity</th>
          <th>Price</th>
          <th>Status</th>
          <th>Actions</th>
        </tr>
      </thead>
      <tbody id="itemsTable">
        <tr>
          <td colspan="7" class="text-center">
            <div class="spinner"></div>
          </td>
        </tr>
      </tbody>
    </table>
  </div>
</div>

<script>
  async function loadItems() {
    const search = document.getElementById('searchInput').value;
    const tbody = document.getElementById('itemsTable');

    try {
      const response = await fetch(`/api/items?search=${encodeURIComponent(search)}`);
      const result = await response.json();

      if (result.success) {
        displayItems(result.data);
      }
    } catch (error) {
      console.error('Error loading items:', error);
      tbody.innerHTML = '<tr><td colspan="7" class="text-center">Error loading items</td></tr>';
    }
  }

  async function loadLowStock() {
    const tbody = document.getElementById('itemsTable');

    try {
      const response = await fetch('/api/items/low-stock');
      const result = await response.json();

      if (result.success) {
        displayItems(result.data);
      }
    } catch (error) {
      console.error('Error loading low stock items:', error);
      tbody.innerHTML = '<tr><td colspan="7" class="text-center">Error loading items</td></tr>';
    }
  }

  function displayItems(items) {
    const tbody = document.getElementById('itemsTable');

    if (items.length === 0) {
      tbody.innerHTML = '<tr><td colspan="7" class="text-center">No items found</td></tr>';
    } else {
      tbody.innerHTML = items.map(item => {
        const isLowStock = item.quantity <= item.minQuantity;
        const statusClass = isLowStock ? 'low-stock' : '';
        const statusIcon = isLowStock ? '<i class="fas fa-exclamation-triangle low-stock-icon"></i>' : '<i class="fas fa-check" style="color: var(--success);"></i>';
        const quantityClass = isLowStock ? 'low-stock' : '';

        return `
          <tr>
            <td>${item.name}</td>
            <td><span class="badge ${item.itemType === 'Product' ? 'badge-info' : 'badge-success'}">${item.itemType}</span></td>
            <td class="${quantityClass}">${item.quantity}</td>
            <td>${item.minQuantity}</td>
            <td>$${item.price.toFixed(2)}</td>
            <td>${statusIcon}</td>
            <td>
              <button class="btn btn-sm btn-secondary" onclick="editItem(${item.id})">
                <i class="fas fa-edit"></i> Edit
              </button>
              <button class="btn btn-sm btn-danger" onclick="deleteItem(${item.id})">
                <i class="fas fa-trash"></i> Delete
              </button>
            </td>
          </tr>
        `;
      }).join('');
    }
  }

  function showAddModal() {
    alert('Add Item form - Name, Type, Quantity, Min Quantity, Price');
  }

  function editItem(id) {
    alert(`Edit item ${id}`);
  }

  async function deleteItem(id) {
    if (!confirm('Are you sure you want to delete this item?')) return;

    try {
      const response = await fetch(`/api/items/${id}`, { method: 'DELETE' });
      const result = await response.json();

      if (result.success) {
        alert(result.message);
        loadItems();
      } else {
        alert('Error: ' + result.message);
      }
    } catch (error) {
      console.error('Error deleting item:', error);
      alert('Error deleting item');
    }
  }

  loadItems();
</script>
