<div class="page-header">
  <h2><i class="fas fa-paw"></i> Patients</h2>
  <p>Manage pet records and medical information</p>
</div>

<!-- Search and Add -->
<div class="flex-between mb-3">
  <div class="search-bar" style="flex: 1; max-width: 500px;">
    <input type="text" id="searchInput" placeholder="Search patients by name, species, or owner...">
    <button class="btn btn-secondary" onclick="loadPatients()">
      <i class="fas fa-search"></i> Search
    </button>
  </div>
  <button class="btn btn-primary" onclick="showAddModal()">
    <i class="fas fa-plus"></i> Add Patient
  </button>
</div>

<!-- Patients Table -->
<div class="card">
  <div class="table-container">
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Species</th>
          <th>Breed</th>
          <th>Owner</th>
          <th>Birth Date</th>
          <th>Actions</th>
        </tr>
      </thead>
      <tbody id="patientsTable">
        <tr>
          <td colspan="6" class="text-center">
            <div class="spinner"></div>
          </td>
        </tr>
      </tbody>
    </table>
  </div>
</div>

<script>
  async function loadPatients() {
    const search = document.getElementById('searchInput').value;
    const tbody = document.getElementById('patientsTable');

    try {
      const response = await fetch(`/api/patients?search=${encodeURIComponent(search)}`);
      const result = await response.json();

      if (result.success) {
        if (result.data.length === 0) {
          tbody.innerHTML = '<tr><td colspan="6" class="text-center">No patients found</td></tr>';
        } else {
          tbody.innerHTML = result.data.map(patient => {
            const birthDate = patient.birthDate ? new Date(patient.birthDate).toLocaleDateString() : '-';
            return `
              <tr>
                <td>${patient.name}</td>
                <td>${patient.species}</td>
                <td>${patient.breed || '-'}</td>
                <td>${patient.client.name}</td>
                <td>${birthDate}</td>
                <td>
                  <button class="btn btn-sm btn-secondary" onclick="viewPatient(${patient.id})">
                    <i class="fas fa-eye"></i> View
                  </button>
                  <button class="btn btn-sm btn-danger" onclick="deletePatient(${patient.id})">
                    <i class="fas fa-trash"></i> Delete
                  </button>
                </td>
              </tr>
            `;
          }).join('');
        }
      }
    } catch (error) {
      console.error('Error loading patients:', error);
      tbody.innerHTML = '<tr><td colspan="6" class="text-center">Error loading patients</td></tr>';
    }
  }

  function showAddModal() {
    alert('Add Patient form - Connect to client selection and form modal');
  }

  function viewPatient(id) {
    alert(`View patient ${id} - Show detailed patient information`);
  }

  async function deletePatient(id) {
    if (!confirm('Are you sure you want to delete this patient?')) return;

    try {
      const response = await fetch(`/api/patients/${id}`, { method: 'DELETE' });
      const result = await response.json();

      if (result.success) {
        alert(result.message);
        loadPatients();
      } else {
        alert('Error: ' + result.message);
      }
    } catch (error) {
      console.error('Error deleting patient:', error);
      alert('Error deleting patient');
    }
  }

  loadPatients();
</script>
