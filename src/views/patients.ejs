<div class="page-header">
  <h2><i class="fas fa-paw"></i> Patients</h2>
  <p>Manage pet records and medical information</p>
</div>

<!-- Search and Add -->
<div class="flex-between mb-3">
  <div class="search-bar" style="flex: 1; max-width: 500px;">
    <input type="text" id="searchInput" placeholder="Search patients by name, species, or owner...">
    <button class="btn btn-secondary" onclick="loadPatients()">
      <i class="fas fa-search"></i> Search
    </button>
  </div>
  <button class="btn btn-primary" onclick="showAddModal()">
    <i class="fas fa-plus"></i> Add Patient
  </button>
</div>

<!-- Patients Table -->
<div class="card">
  <div class="table-container">
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Species</th>
          <th>Breed</th>
          <th>Owner</th>
          <th>Birth Date</th>
          <th>Actions</th>
        </tr>
      </thead>
      <tbody id="patientsTable">
        <tr>
          <td colspan="6" class="text-center">
            <div class="spinner"></div>
          </td>
        </tr>
      </tbody>
    </table>
  </div>
</div>

<!-- Add/Edit Patient Modal -->
<div class="modal-overlay" id="patientModal">
  <div class="modal" style="max-width: 650px;">
    <div class="modal-header">
      <h3 id="modalTitle">Add Patient</h3>
      <button class="modal-close" onclick="closeModal()">&times;</button>
    </div>
    <form id="patientForm" onsubmit="savePatient(event)">
      <input type="hidden" id="patientId">

      <div class="form-group">
        <label class="form-label">Owner/Client *</label>
        <input
          type="text"
          id="clientSearch"
          class="form-control"
          placeholder="Search client by name..."
          autocomplete="off"
          onkeyup="filterClients()"
          onfocus="showClientDropdown()"
        >
        <select id="patientClient" class="form-control" required style="margin-top: 5px; display: none;" size="5" onchange="selectClient()" onfocus="showClientDropdown()">
          <option value="">-- Select a client --</option>
        </select>
        <input type="hidden" id="selectedClientId" required>
        <small style="color: #666;">Don't see the client? <a href="/clients" style="color: #2d6a4f;">Add a new client first</a></small>
      </div>

      <div class="form-row">
        <div class="form-group">
          <label class="form-label">Pet Name *</label>
          <input type="text" id="patientName" class="form-control" required>
        </div>

        <div class="form-group">
          <label class="form-label">Species *</label>
          <select id="patientSpecies" class="form-control" required>
            <option value="">Select species</option>
            <option value="Dog">Dog</option>
            <option value="Cat">Cat</option>
            <option value="Bird">Bird</option>
            <option value="Rabbit">Rabbit</option>
            <option value="Hamster">Hamster</option>
            <option value="Guinea Pig">Guinea Pig</option>
            <option value="Reptile">Reptile</option>
            <option value="Other">Other</option>
          </select>
        </div>
      </div>

      <div class="form-row">
        <div class="form-group">
          <label class="form-label">Breed</label>
          <input type="text" id="patientBreed" class="form-control" placeholder="e.g., Golden Retriever">
        </div>

        <div class="form-group">
          <label class="form-label">Gender</label>
          <select id="patientGender" class="form-control">
            <option value="">Select gender</option>
            <option value="Male">Male</option>
            <option value="Female">Female</option>
          </select>
        </div>
      </div>

      <div class="form-row">
        <div class="form-group">
          <label class="form-label">Weight (kg)</label>
          <input type="number" id="patientWeight" class="form-control" step="0.1" min="0" placeholder="e.g., 5.5">
        </div>

        <div class="form-group">
          <label class="form-label">Birth Date</label>
          <input type="date" id="patientBirthDate" class="form-control">
        </div>
      </div>

      <div class="form-row">
        <div class="form-group">
          <label class="form-label">Contact Number (CP)</label>
          <input type="text" id="patientPhone" class="form-control" placeholder="e.g., 09123456789">
        </div>

        <div class="form-group">
          <label class="form-label">Color/Markings</label>
          <input type="text" id="patientColor" class="form-control" placeholder="e.g., Brown with white spots">
        </div>
      </div>

      <div class="form-group">
        <label class="form-label">Address</label>
        <input type="text" id="patientAddress" class="form-control" placeholder="Complete address">
      </div>

      <div class="form-group">
        <label class="form-label">Notes / Medical History</label>
        <textarea id="patientNotes" class="form-control" rows="2" placeholder="Medical history, allergies, behavioral notes, etc."></textarea>
      </div>

      <div class="form-row">
        <div class="form-group">
          <label class="form-label">TX (Treatment)</label>
          <textarea id="patientTX" class="form-control" rows="2" placeholder="Treatment history..."></textarea>
        </div>

        <div class="form-group">
          <label class="form-label">RX (Prescription)</label>
          <textarea id="patientRX" class="form-control" rows="2" placeholder="Prescription history..."></textarea>
        </div>
      </div>

      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" onclick="closeModal()">
          <i class="fas fa-times"></i> Cancel
        </button>
        <button type="submit" class="btn btn-primary">
          <i class="fas fa-save"></i> Save Patient
        </button>
      </div>
    </form>
  </div>
</div>

<script>
  let currentPatientId = null;

  async function loadPatients() {
    const search = document.getElementById('searchInput').value;
    const tbody = document.getElementById('patientsTable');

    try {
      const response = await fetch(`/api/patients?search=${encodeURIComponent(search)}`);
      const result = await response.json();

      if (result.success) {
        if (result.data.length === 0) {
          tbody.innerHTML = '<tr><td colspan="6" class="text-center">No patients found</td></tr>';
        } else {
          tbody.innerHTML = result.data.map(patient => {
            const birthDate = patient.birthDate ? new Date(patient.birthDate).toLocaleDateString() : '-';
            return `
              <tr>
                <td>${patient.name}</td>
                <td>${patient.species}</td>
                <td>${patient.breed || '-'}</td>
                <td>${patient.client.name}</td>
                <td>${birthDate}</td>
                <td>
                  <button class="btn btn-sm btn-secondary" onclick="editPatient(${patient.id})">
                    <i class="fas fa-edit"></i> Edit
                  </button>
                  <button class="btn btn-sm btn-danger" onclick="deletePatient(${patient.id})">
                    <i class="fas fa-trash"></i> Delete
                  </button>
                </td>
              </tr>
            `;
          }).join('');
        }
      }
    } catch (error) {
      console.error('Error loading patients:', error);
      tbody.innerHTML = '<tr><td colspan="6" class="text-center">Error loading patients</td></tr>';
    }
  }

  let allClients = [];

  async function loadClients() {
    try {
      const response = await fetch('/api/clients');
      const result = await response.json();

      if (result.success) {
        allClients = result.data;
        displayClients(allClients);
      }
    } catch (error) {
      console.error('Error loading clients:', error);
    }
  }

  function displayClients(clients) {
    const select = document.getElementById('patientClient');
    select.innerHTML = '<option value="">-- Select a client --</option>';

    clients.forEach(client => {
      const option = document.createElement('option');
      option.value = client.id;
      option.textContent = client.name;
      option.setAttribute('data-email', client.email || '');
      option.setAttribute('data-phone', client.phone || '');
      select.appendChild(option);
    });
  }

  function filterClients() {
    const searchTerm = document.getElementById('clientSearch').value.toLowerCase();

    if (searchTerm === '') {
      displayClients(allClients);
      return;
    }

    const filtered = allClients.filter(client =>
      client.name.toLowerCase().includes(searchTerm) ||
      (client.email && client.email.toLowerCase().includes(searchTerm)) ||
      (client.phone && client.phone.includes(searchTerm))
    );

    displayClients(filtered);

    // Show the dropdown
    const select = document.getElementById('patientClient');
    select.style.display = 'block';
  }

  function selectClient() {
    const select = document.getElementById('patientClient');
    const selectedOption = select.options[select.selectedIndex];

    if (selectedOption.value) {
      document.getElementById('clientSearch').value = selectedOption.textContent;
      document.getElementById('selectedClientId').value = selectedOption.value;
      select.style.display = 'none';
    }
  }

  function showClientDropdown() {
    const select = document.getElementById('patientClient');
    select.style.display = 'block';
  }

  // Hide dropdown when clicking outside
  document.addEventListener('click', function(e) {
    const select = document.getElementById('patientClient');
    const searchInput = document.getElementById('clientSearch');

    if (select && searchInput && e.target !== select && e.target !== searchInput) {
      select.style.display = 'none';
    }
  });

  async function showAddModal() {
    await loadClients();
    document.getElementById('modalTitle').textContent = 'Add Patient';
    document.getElementById('patientForm').reset();
    document.getElementById('patientId').value = '';
    document.getElementById('clientSearch').value = '';
    document.getElementById('selectedClientId').value = '';
    document.getElementById('patientClient').style.display = 'none';
    document.getElementById('patientModal').classList.add('active');
  }

  async function editPatient(id) {
    try {
      await loadClients();
      const response = await fetch(`/api/patients/${id}`);
      const result = await response.json();

      if (result.success) {
        const patient = result.data;
        document.getElementById('modalTitle').textContent = 'Edit Patient';
        document.getElementById('patientId').value = patient.id;

        // Set client search and selection
        document.getElementById('clientSearch').value = patient.client.name;
        document.getElementById('selectedClientId').value = patient.clientId;
        document.getElementById('patientClient').value = patient.clientId;
        document.getElementById('patientClient').style.display = 'none';

        document.getElementById('patientName').value = patient.name;
        document.getElementById('patientSpecies').value = patient.species;
        document.getElementById('patientBreed').value = patient.breed || '';
        document.getElementById('patientGender').value = patient.gender || '';
        document.getElementById('patientWeight').value = patient.weight || '';
        document.getElementById('patientBirthDate').value = patient.birthDate ? patient.birthDate.split('T')[0] : '';
        document.getElementById('patientPhone').value = patient.phone || '';
        document.getElementById('patientColor').value = patient.color || '';
        document.getElementById('patientAddress').value = patient.address || '';
        document.getElementById('patientNotes').value = patient.notes || '';
        document.getElementById('patientTX').value = patient.treatment || '';
        document.getElementById('patientRX').value = patient.prescription || '';
        document.getElementById('patientModal').classList.add('active');
      }
    } catch (error) {
      console.error('Error loading patient:', error);
      alert('Error loading patient details');
    }
  }

  async function savePatient(event) {
    event.preventDefault();

    const id = document.getElementById('patientId').value;
    const clientId = document.getElementById('selectedClientId').value;

    if (!clientId) {
      alert('Please select a client');
      return;
    }

    const data = {
      clientId: clientId,
      name: document.getElementById('patientName').value,
      species: document.getElementById('patientSpecies').value,
      breed: document.getElementById('patientBreed').value || null,
      gender: document.getElementById('patientGender').value || null,
      weight: document.getElementById('patientWeight').value ? parseFloat(document.getElementById('patientWeight').value) : null,
      birthDate: document.getElementById('patientBirthDate').value || null,
      phone: document.getElementById('patientPhone').value || null,
      color: document.getElementById('patientColor').value || null,
      address: document.getElementById('patientAddress').value || null,
      notes: document.getElementById('patientNotes').value || null,
      treatment: document.getElementById('patientTX').value || null,
      prescription: document.getElementById('patientRX').value || null,
    };

    const url = id ? `/api/patients/${id}` : '/api/patients';
    const method = id ? 'PUT' : 'POST';

    try {
      const response = await fetch(url, {
        method,
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(data),
      });

      const result = await response.json();

      if (result.success) {
        alert(id ? 'Patient updated successfully!' : 'Patient added successfully!');
        closeModal();
        loadPatients();
      } else {
        alert('Error: ' + result.message);
      }
    } catch (error) {
      console.error('Error saving patient:', error);
      alert('Error saving patient');
    }
  }

  function viewPatient(id) {
    // For now, just edit the patient. Later can create a detailed view page
    editPatient(id);
  }

  function closeModal() {
    document.getElementById('patientModal').classList.remove('active');
  }

  async function deletePatient(id) {
    if (!confirm('Are you sure you want to delete this patient?')) return;

    try {
      const response = await fetch(`/api/patients/${id}`, { method: 'DELETE' });
      const result = await response.json();

      if (result.success) {
        alert(result.message);
        loadPatients();
      } else {
        alert('Error: ' + result.message);
      }
    } catch (error) {
      console.error('Error deleting patient:', error);
      alert('Error deleting patient');
    }
  }

  loadPatients();
</script>
