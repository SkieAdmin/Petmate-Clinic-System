<div class="page-header">
  <h2><i class="fas fa-users"></i> Clients</h2>
  <p>Manage pet owners and client information</p>
</div>

<!-- Search and Add -->
<div class="flex-between mb-3">
  <div class="search-bar" style="flex: 1; max-width: 500px;">
    <input type="text" id="searchInput" placeholder="Search clients by name, email, or phone...">
    <button class="btn btn-secondary" onclick="loadClients()">
      <i class="fas fa-search"></i> Search
    </button>
  </div>
  <button class="btn btn-primary" onclick="showAddModal()">
    <i class="fas fa-plus"></i> Add Client
  </button>
</div>

<!-- Clients Table -->
<div class="card">
  <div class="table-container">
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Phone</th>
          <th>Email</th>
          <th>Pets</th>
          <th>Actions</th>
        </tr>
      </thead>
      <tbody id="clientsTable">
        <tr>
          <td colspan="5" class="text-center">
            <div class="spinner"></div>
          </td>
        </tr>
      </tbody>
    </table>
  </div>
</div>

<!-- Add/Edit Client Modal (Simple Form Popup) -->
<div id="clientModal" class="modal hidden" style="position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 2000; display: flex; align-items: center; justify-content: center;">
  <div class="card" style="width: 90%; max-width: 500px; max-height: 90vh; overflow-y: auto;">
    <div class="card-header">
      <h3 class="card-title" id="modalTitle">Add Client</h3>
      <button onclick="closeModal()" style="background: none; border: none; font-size: 1.5rem; cursor: pointer;">&times;</button>
    </div>
    <form id="clientForm" onsubmit="saveClient(event)">
      <input type="hidden" id="clientId">
      <div class="form-group">
        <label class="form-label">Name *</label>
        <input type="text" id="clientName" class="form-control" required>
      </div>
      <div class="form-group">
        <label class="form-label">Phone</label>
        <input type="tel" id="clientPhone" class="form-control">
      </div>
      <div class="form-group">
        <label class="form-label">Email</label>
        <input type="email" id="clientEmail" class="form-control">
      </div>
      <div class="form-group">
        <label class="form-label">Address</label>
        <textarea id="clientAddress" class="form-control" rows="3"></textarea>
      </div>
      <div class="flex gap-1">
        <button type="submit" class="btn btn-primary">Save</button>
        <button type="button" class="btn btn-secondary" onclick="closeModal()">Cancel</button>
      </div>
    </form>
  </div>
</div>

<script>
  let currentClientId = null;

  async function loadClients() {
    const search = document.getElementById('searchInput').value;
    const tbody = document.getElementById('clientsTable');

    try {
      const response = await fetch(`/api/clients?search=${encodeURIComponent(search)}`);
      const result = await response.json();

      if (result.success) {
        if (result.data.length === 0) {
          tbody.innerHTML = '<tr><td colspan="5" class="text-center">No clients found</td></tr>';
        } else {
          tbody.innerHTML = result.data.map(client => `
            <tr>
              <td>${client.name}</td>
              <td>${client.phone || '-'}</td>
              <td>${client.email || '-'}</td>
              <td>${client._count.patients}</td>
              <td>
                <button class="btn btn-sm btn-secondary" onclick="editClient(${client.id})">
                  <i class="fas fa-edit"></i> Edit
                </button>
                <button class="btn btn-sm btn-danger" onclick="deleteClient(${client.id})">
                  <i class="fas fa-trash"></i> Delete
                </button>
              </td>
            </tr>
          `).join('');
        }
      }
    } catch (error) {
      console.error('Error loading clients:', error);
      tbody.innerHTML = '<tr><td colspan="5" class="text-center">Error loading clients</td></tr>';
    }
  }

  function showAddModal() {
    document.getElementById('modalTitle').textContent = 'Add Client';
    document.getElementById('clientForm').reset();
    document.getElementById('clientId').value = '';
    document.getElementById('clientModal').classList.remove('hidden');
    document.getElementById('clientModal').style.display = 'flex';
  }

  async function editClient(id) {
    try {
      const response = await fetch(`/api/clients/${id}`);
      const result = await response.json();

      if (result.success) {
        const client = result.data;
        document.getElementById('modalTitle').textContent = 'Edit Client';
        document.getElementById('clientId').value = client.id;
        document.getElementById('clientName').value = client.name;
        document.getElementById('clientPhone').value = client.phone || '';
        document.getElementById('clientEmail').value = client.email || '';
        document.getElementById('clientAddress').value = client.address || '';
        document.getElementById('clientModal').classList.remove('hidden');
        document.getElementById('clientModal').style.display = 'flex';
      }
    } catch (error) {
      console.error('Error loading client:', error);
      alert('Error loading client details');
    }
  }

  async function saveClient(event) {
    event.preventDefault();

    const id = document.getElementById('clientId').value;
    const data = {
      name: document.getElementById('clientName').value,
      phone: document.getElementById('clientPhone').value,
      email: document.getElementById('clientEmail').value,
      address: document.getElementById('clientAddress').value,
    };

    const url = id ? `/api/clients/${id}` : '/api/clients';
    const method = id ? 'PUT' : 'POST';

    try {
      const response = await fetch(url, {
        method,
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(data),
      });

      const result = await response.json();

      if (result.success) {
        alert(result.message);
        closeModal();
        loadClients();
      } else {
        alert('Error: ' + result.message);
      }
    } catch (error) {
      console.error('Error saving client:', error);
      alert('Error saving client');
    }
  }

  async function deleteClient(id) {
    if (!confirm('Are you sure you want to delete this client?')) return;

    try {
      const response = await fetch(`/api/clients/${id}`, { method: 'DELETE' });
      const result = await response.json();

      if (result.success) {
        alert(result.message);
        loadClients();
      } else {
        alert('Error: ' + result.message);
      }
    } catch (error) {
      console.error('Error deleting client:', error);
      alert('Error deleting client');
    }
  }

  function closeModal() {
    document.getElementById('clientModal').classList.add('hidden');
    document.getElementById('clientModal').style.display = 'none';
  }

  // Load clients on page load
  loadClients();
</script>
