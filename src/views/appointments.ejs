<div class="page-header">
  <h2><i class="fas fa-calendar-alt"></i> Appointments</h2>
  <p>Schedule and manage patient appointments</p>
</div>

<!-- Date Range Filter -->
<div class="card mb-3">
  <div class="flex-between">
    <div class="flex gap-1">
      <input type="date" id="startDate" class="form-control" style="width: auto;">
      <input type="date" id="endDate" class="form-control" style="width: auto;">
      <button class="btn btn-secondary" onclick="loadAppointments()">
        <i class="fas fa-filter"></i> Filter
      </button>
      <button class="btn btn-secondary" onclick="loadToday()">
        <i class="fas fa-calendar-day"></i> Today
      </button>
    </div>
    <button class="btn btn-primary" onclick="showAddModal()">
      <i class="fas fa-plus"></i> New Appointment
    </button>
  </div>
</div>

<!-- Appointments Table -->
<div class="card">
  <div class="table-container">
    <table>
      <thead>
        <tr>
          <th>Date & Time</th>
          <th>Patient</th>
          <th>Owner</th>
          <th>Reason</th>
          <th>Status</th>
          <th>Actions</th>
        </tr>
      </thead>
      <tbody id="appointmentsTable">
        <tr>
          <td colspan="6" class="text-center">
            <div class="spinner"></div>
          </td>
        </tr>
      </tbody>
    </table>
  </div>
</div>

<!-- Add/Edit Appointment Modal -->
<div id="appointmentModal" class="modal hidden" style="position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 2000; display: none; align-items: center; justify-content: center;">
  <div class="card" style="width: 90%; max-width: 600px; max-height: 90vh; overflow-y: auto;">
    <div class="card-header">
      <h3 class="card-title" id="modalTitle">New Appointment</h3>
      <button onclick="closeModal()" style="background: none; border: none; font-size: 1.5rem; cursor: pointer;">&times;</button>
    </div>
    <form id="appointmentForm" onsubmit="saveAppointment(event)">
      <input type="hidden" id="appointmentId">

      <div class="form-group">
        <label class="form-label">Patient *</label>
        <input
          type="text"
          id="patientSearch"
          class="form-control"
          placeholder="Search patient by name or owner..."
          autocomplete="off"
          onkeyup="filterPatients()"
          onfocus="showPatientDropdown()"
        >
        <select id="appointmentPatient" class="form-control" required style="margin-top: 5px;" size="5" onchange="selectPatient()" onfocus="showPatientDropdown()">
          <option value="">-- Select a patient --</option>
        </select>
        <input type="hidden" id="selectedPatientId" required>
        <small style="color: #666;">Don't see the patient? <a href="/patients" style="color: #2d6a4f;">Add a new patient first</a></small>
      </div>

      <div class="form-row">
        <div class="form-group">
          <label class="form-label">Date *</label>
          <input type="date" id="appointmentDate" class="form-control" required>
        </div>

        <div class="form-group">
          <label class="form-label">Time *</label>
          <input type="time" id="appointmentTime" class="form-control" required>
        </div>
      </div>

      <div class="form-group">
        <label class="form-label">Reason</label>
        <textarea id="appointmentReason" class="form-control" rows="2" placeholder="e.g., Annual checkup, Vaccination, Follow-up"></textarea>
      </div>

      <div class="form-group">
        <label class="form-label">Status *</label>
        <select id="appointmentStatus" class="form-control" required>
          <option value="Scheduled">Scheduled</option>
          <option value="Confirmed">Confirmed</option>
          <option value="Completed">Completed</option>
          <option value="Canceled">Canceled</option>
        </select>
      </div>

      <div class="form-group">
        <label class="form-label">Notes</label>
        <textarea id="appointmentNotes" class="form-control" rows="2" placeholder="Additional notes..."></textarea>
      </div>

      <div class="flex gap-1">
        <button type="submit" class="btn btn-primary">
          <i class="fas fa-save"></i> Save Appointment
        </button>
        <button type="button" class="btn btn-secondary" onclick="closeModal()">
          <i class="fas fa-times"></i> Cancel
        </button>
      </div>
    </form>
  </div>
</div>

<script>
  let allPatients = [];

  async function loadAppointments() {
    const startDate = document.getElementById('startDate').value;
    const endDate = document.getElementById('endDate').value;
    const tbody = document.getElementById('appointmentsTable');

    let url = '/api/appointments';
    if (startDate && endDate) {
      url += `?startDate=${startDate}&endDate=${endDate}`;
    }

    try {
      const response = await fetch(url);
      const result = await response.json();

      if (result.success) {
        if (result.data.length === 0) {
          tbody.innerHTML = '<tr><td colspan="6" class="text-center">No appointments found</td></tr>';
        } else {
          tbody.innerHTML = result.data.map(apt => {
            const dateTime = new Date(apt.dateTime);
            const statusBadge = apt.status === 'Completed' ? 'badge-success' :
                               apt.status === 'Canceled' ? 'badge-danger' : 'badge-info';
            return `
              <tr>
                <td>${dateTime.toLocaleString()}</td>
                <td>${apt.patient.name}</td>
                <td>${apt.patient.client.name}</td>
                <td>${apt.reason || '-'}</td>
                <td>
                  <span class="badge ${statusBadge}" style="cursor: pointer;" onclick="quickChangeStatus(${apt.id}, '${apt.status}', this)" title="Click to change status">
                    ${apt.status} <i class="fas fa-edit" style="font-size: 10px; margin-left: 4px;"></i>
                  </span>
                </td>
                <td>
                  <button class="btn btn-sm btn-secondary" onclick="editAppointment(${apt.id})">
                    <i class="fas fa-edit"></i> Edit
                  </button>
                  <button class="btn btn-sm btn-danger" onclick="deleteAppointment(${apt.id})">
                    <i class="fas fa-trash"></i> Delete
                  </button>
                </td>
              </tr>
            `;
          }).join('');
        }
      }
    } catch (error) {
      console.error('Error loading appointments:', error);
      tbody.innerHTML = '<tr><td colspan="6" class="text-center">Error loading appointments</td></tr>';
    }
  }

  function loadToday() {
    const today = new Date().toISOString().split('T')[0];
    document.getElementById('startDate').value = today;
    document.getElementById('endDate').value = today;
    loadAppointments();
  }

  async function loadPatients() {
    try {
      const response = await fetch('/api/patients');
      const result = await response.json();

      if (result.success) {
        allPatients = result.data;
        displayPatients(allPatients);
      }
    } catch (error) {
      console.error('Error loading patients:', error);
    }
  }

  function displayPatients(patients) {
    const select = document.getElementById('appointmentPatient');
    select.innerHTML = '<option value="">-- Select a patient --</option>';

    patients.forEach(patient => {
      const option = document.createElement('option');
      option.value = patient.id;
      option.textContent = `${patient.name} (${patient.species}) - Owner: ${patient.client.name}`;
      select.appendChild(option);
    });
  }

  function filterPatients() {
    const searchTerm = document.getElementById('patientSearch').value.toLowerCase();

    if (searchTerm === '') {
      displayPatients(allPatients);
      return;
    }

    const filtered = allPatients.filter(patient =>
      patient.name.toLowerCase().includes(searchTerm) ||
      patient.species.toLowerCase().includes(searchTerm) ||
      patient.client.name.toLowerCase().includes(searchTerm)
    );

    displayPatients(filtered);
    const select = document.getElementById('appointmentPatient');
    select.style.display = 'block';
  }

  function selectPatient() {
    const select = document.getElementById('appointmentPatient');
    const selectedOption = select.options[select.selectedIndex];

    if (selectedOption.value) {
      document.getElementById('patientSearch').value = selectedOption.textContent;
      document.getElementById('selectedPatientId').value = selectedOption.value;
      select.style.display = 'none';
    }
  }

  function showPatientDropdown() {
    const select = document.getElementById('appointmentPatient');
    select.style.display = 'block';
  }

  // Hide dropdown when clicking outside
  document.addEventListener('click', function(e) {
    const select = document.getElementById('appointmentPatient');
    const searchInput = document.getElementById('patientSearch');

    if (select && searchInput && e.target !== select && e.target !== searchInput) {
      select.style.display = 'none';
    }
  });

  async function showAddModal() {
    await loadPatients();
    document.getElementById('modalTitle').textContent = 'New Appointment';
    document.getElementById('appointmentForm').reset();
    document.getElementById('appointmentId').value = '';
    document.getElementById('patientSearch').value = '';
    document.getElementById('selectedPatientId').value = '';
    document.getElementById('appointmentPatient').style.display = 'none';

    // Set default date to today
    const today = new Date().toISOString().split('T')[0];
    document.getElementById('appointmentDate').value = today;

    // Set default time to next hour
    const now = new Date();
    now.setHours(now.getHours() + 1);
    const hours = String(now.getHours()).padStart(2, '0');
    const minutes = '00';
    document.getElementById('appointmentTime').value = `${hours}:${minutes}`;

    document.getElementById('appointmentModal').classList.remove('hidden');
    document.getElementById('appointmentModal').style.display = 'flex';
  }

  async function editAppointment(id) {
    try {
      await loadPatients();
      const response = await fetch(`/api/appointments/${id}`);
      const result = await response.json();

      if (result.success) {
        const apt = result.data;
        document.getElementById('modalTitle').textContent = 'Edit Appointment';
        document.getElementById('appointmentId').value = apt.id;

        // Set patient
        document.getElementById('patientSearch').value = `${apt.patient.name} (${apt.patient.species}) - Owner: ${apt.patient.client.name}`;
        document.getElementById('selectedPatientId').value = apt.patientId;
        document.getElementById('appointmentPatient').value = apt.patientId;
        document.getElementById('appointmentPatient').style.display = 'none';

        // Set date and time
        const dateTime = new Date(apt.dateTime);
        document.getElementById('appointmentDate').value = dateTime.toISOString().split('T')[0];
        document.getElementById('appointmentTime').value = dateTime.toTimeString().slice(0, 5);

        document.getElementById('appointmentReason').value = apt.reason || '';
        document.getElementById('appointmentStatus').value = apt.status;
        document.getElementById('appointmentNotes').value = apt.notes || '';

        document.getElementById('appointmentModal').classList.remove('hidden');
        document.getElementById('appointmentModal').style.display = 'flex';
      }
    } catch (error) {
      console.error('Error loading appointment:', error);
      alert('Error loading appointment details');
    }
  }

  async function saveAppointment(event) {
    event.preventDefault();

    const id = document.getElementById('appointmentId').value;
    const patientId = document.getElementById('selectedPatientId').value;

    if (!patientId) {
      alert('Please select a patient');
      return;
    }

    const date = document.getElementById('appointmentDate').value;
    const time = document.getElementById('appointmentTime').value;
    const dateTime = `${date}T${time}:00`;

    const data = {
      patientId: patientId,
      dateTime: dateTime,
      reason: document.getElementById('appointmentReason').value || null,
      status: document.getElementById('appointmentStatus').value,
      notes: document.getElementById('appointmentNotes').value || null,
    };

    const url = id ? `/api/appointments/${id}` : '/api/appointments';
    const method = id ? 'PUT' : 'POST';

    try {
      const response = await fetch(url, {
        method,
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(data),
      });

      const result = await response.json();

      if (result.success) {
        alert(id ? 'Appointment updated successfully!' : 'Appointment created successfully!');
        closeModal();
        loadAppointments();
      } else {
        alert('Error: ' + result.message);
      }
    } catch (error) {
      console.error('Error saving appointment:', error);
      alert('Error saving appointment');
    }
  }

  function closeModal() {
    document.getElementById('appointmentModal').classList.add('hidden');
    document.getElementById('appointmentModal').style.display = 'none';
  }

  // Quick status change function
  async function quickChangeStatus(appointmentId, currentStatus, element) {
    const statuses = ['Scheduled', 'Confirmed', 'Completed', 'Canceled'];

    // Create a custom prompt with options
    let message = 'Change appointment status to:\n\n';
    statuses.forEach((status, index) => {
      if (status !== currentStatus) {
        message += `${index + 1}. ${status}\n`;
      }
    });
    message += '\nEnter the number (1-4) or cancel:';

    // Show available statuses
    const options = statuses.filter(s => s !== currentStatus);
    let optionText = 'Select new status:\n\n';
    options.forEach((status, index) => {
      optionText += `${index + 1}. ${status}\n`;
    });

    const choice = prompt(optionText);

    if (!choice) return; // User cancelled

    const choiceIndex = parseInt(choice) - 1;
    if (choiceIndex < 0 || choiceIndex >= options.length) {
      alert('Invalid selection');
      return;
    }

    const newStatus = options[choiceIndex];

    // Confirm the change
    const confirmMessage = `Are you sure you want to change the status from "${currentStatus}" to "${newStatus}"?`;
    if (!confirm(confirmMessage)) return;

    // Update status via API
    try {
      const response = await fetch(`/api/appointments/${appointmentId}`, {
        method: 'PUT',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ status: newStatus }),
      });

      const result = await response.json();

      if (result.success) {
        // Update the badge without reloading the whole table
        const statusBadge = newStatus === 'Completed' ? 'badge-success' :
                           newStatus === 'Canceled' ? 'badge-danger' : 'badge-info';
        element.className = `badge ${statusBadge}`;
        element.innerHTML = `${newStatus} <i class="fas fa-edit" style="font-size: 10px; margin-left: 4px;"></i>`;
        element.onclick = function() { quickChangeStatus(appointmentId, newStatus, this); };

        // Show success message
        alert(`Status updated to "${newStatus}" successfully!`);
      } else {
        alert('Error: ' + result.message);
      }
    } catch (error) {
      console.error('Error updating status:', error);
      alert('Error updating status. Please try again.');
    }
  }

  async function deleteAppointment(id) {
    if (!confirm('Are you sure you want to delete this appointment?')) return;

    try {
      const response = await fetch(`/api/appointments/${id}`, { method: 'DELETE' });
      const result = await response.json();

      if (result.success) {
        alert(result.message);
        loadAppointments();
      } else {
        alert('Error: ' + result.message);
      }
    } catch (error) {
      console.error('Error deleting appointment:', error);
      alert('Error deleting appointment');
    }
  }

  // Set default dates to current month
  const now = new Date();
  const firstDay = new Date(now.getFullYear(), now.getMonth(), 1);
  const lastDay = new Date(now.getFullYear(), now.getMonth() + 1, 0);
  document.getElementById('startDate').value = firstDay.toISOString().split('T')[0];
  document.getElementById('endDate').value = lastDay.toISOString().split('T')[0];

  loadAppointments();
</script>
